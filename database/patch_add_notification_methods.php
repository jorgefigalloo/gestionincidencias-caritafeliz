<?php
// Script para agregar los nuevos métodos de notificación a EmailNotifier.php

$file = 'c:/xampp/htdocs/gestion-incidencias/api/models/EmailNotifier.php';
$content = file_get_contents($file);

// Buscar el final de la clase (antes del cierre)
$search = "    }\r\n}\r\n?>";

$newMethods = "    }\r\n    \r\n    /**\r\n     * Enviar notificación cuando se crea una nueva incidencia\r\n     */\r\n    public function notificarNuevaIncidencia(\$idIncidencia, \$idAdmin) {\r\n        try {\r\n            \$stmt = \$this->pdo->prepare(\"\r\n                SELECT i.*, \r\n                       u.email as admin_email, \r\n                       u.nombre_completo as admin_nombre,\r\n                       u.notificaciones_activas,\r\n                       COALESCE(ur.nombre_completo, i.nombre_reporta) as reportante\r\n                FROM incidencias i\r\n                LEFT JOIN usuarios ur ON i.id_usuario_reporta = ur.id_usuario\r\n                CROSS JOIN usuarios u\r\n                WHERE i.id_incidencia = ? AND u.id_usuario = ?\r\n            \");\r\n            \$stmt->execute([\$idIncidencia, \$idAdmin]);\r\n            \$data = \$stmt->fetch(PDO::FETCH_ASSOC);\r\n            \r\n            if (!\$data || !\$data['notificaciones_activas'] || !\$data['admin_email']) {\r\n                return false;\r\n            }\r\n            \r\n            \$asunto = \"Nueva incidencia reportada #{\$idIncidencia}: {\$data['titulo']}\";\r\n            \$mensaje = \$this->generarMensajeNuevaIncidencia(\$data);\r\n            \r\n            \$this->registrarNotificacion(\$idIncidencia, \$idAdmin, 'nueva_incidencia', \$asunto, \$mensaje);\r\n            return \$this->enviarEmail(\$data['admin_email'], \$asunto, \$mensaje);\r\n            \r\n        } catch (Exception \$e) {\r\n            error_log(\"EmailNotifier::notificarNuevaIncidencia: \" . \$e->getMessage());\r\n            return false;\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Enviar notificación urgente cuando se crea una incidencia crítica\r\n     */\r\n    public function notificarIncidenciaCritica(\$idIncidencia, \$idAdmin) {\r\n        try {\r\n            \$stmt = \$this->pdo->prepare(\"\r\n                SELECT i.*, \r\n                       u.email as admin_email, \r\n                       u.nombre_completo as admin_nombre,\r\n                       u.notificaciones_activas,\r\n                       COALESCE(ur.nombre_completo, i.nombre_reporta) as reportante\r\n                FROM incidencias i\r\n                LEFT JOIN usuarios ur ON i.id_usuario_reporta = ur.id_usuario\r\n                CROSS JOIN usuarios u\r\n                WHERE i.id_incidencia = ? AND u.id_usuario = ?\r\n            \");\r\n            \$stmt->execute([\$idIncidencia, \$idAdmin]);\r\n            \$data = \$stmt->fetch(PDO::FETCH_ASSOC);\r\n            \r\n            if (!\$data || !\$data['notificaciones_activas'] || !\$data['admin_email']) {\r\n                return false;\r\n            }\r\n            \r\n            \$asunto = \"URGENTE - Incidencia CRÍTICA #{\$idIncidencia}: {\$data['titulo']}\";\r\n            \$mensaje = \$this->generarMensajeIncidenciaCritica(\$data);\r\n            \r\n            \$this->registrarNotificacion(\$idIncidencia, \$idAdmin, 'incidencia_critica', \$asunto, \$mensaje);\r\n            return \$this->enviarEmail(\$data['admin_email'], \$asunto, \$mensaje);\r\n            \r\n        } catch (Exception \$e) {\r\n            error_log(\"EmailNotifier::notificarIncidenciaCritica: \" . \$e->getMessage());\r\n            return false;\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Generar mensaje HTML para nueva incidencia\r\n     */\r\n    private function generarMensajeNuevaIncidencia(\$data) {\r\n        return \"\r\n        <html>\r\n        <body style='font-family: Arial, sans-serif; line-height: 1.6; color: #333;'>\r\n            <div style='max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px;'>\r\n                <h2 style='color: #0D9488; border-bottom: 2px solid #0D9488; padding-bottom: 10px;'>\r\n                    Nueva Incidencia Reportada\r\n                </h2>\r\n                \r\n                <p>Hola <strong>{\$data['admin_nombre']}</strong>,</p>\r\n                \r\n                <p>Se ha reportado una nueva incidencia en el sistema:</p>\r\n                \r\n                <div style='background: #F0FDFA; padding: 15px; border-left: 4px solid #0D9488; margin: 20px 0;'>\r\n                    <p><strong>ID:</strong> #{\$data['id_incidencia']}</p>\r\n                    <p><strong>Título:</strong> {\$data['titulo']}</p>\r\n                    <p><strong>Descripción:</strong> {\$data['descripcion']}</p>\r\n                    <p><strong>Prioridad:</strong> <span style='color: \" . \$this->getColorPrioridad(\$data['prioridad']) . \";'>\" . strtoupper(\$data['prioridad']) . \"</span></p>\r\n                    <p><strong>Reportado por:</strong> {\$data['reportante']}</p>\r\n                </div>\r\n                \r\n                <p>Por favor, revisa y asigna un técnico para atender esta incidencia.</p>\r\n                \r\n                <p style='margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px;'>\r\n                    Este es un mensaje automático del Sistema de Gestión de Incidencias - Clínica Carita Feliz\r\n                </p>\r\n            </div>\r\n        </body>\r\n        </html>\r\n        \";\r\n    }\r\n    \r\n    /**\r\n     * Generar mensaje HTML para incidencia crítica\r\n     */\r\n    private function generarMensajeIncidenciaCritica(\$data) {\r\n        return \"\r\n        <html>\r\n        <body style='font-family: Arial, sans-serif; line-height: 1.6; color: #333;'>\r\n            <div style='max-width: 600px; margin: 0 auto; padding: 20px; border: 2px solid #EF4444; border-radius: 10px;'>\r\n                <h2 style='color: #EF4444; border-bottom: 2px solid #EF4444; padding-bottom: 10px;'>\r\n                    URGENTE - Incidencia CRÍTICA\r\n                </h2>\r\n                \r\n                <p>Hola <strong>{\$data['admin_nombre']}</strong>,</p>\r\n                \r\n                <div style='background: #FEE2E2; padding: 15px; border-radius: 5px; margin: 20px 0;'>\r\n                    <p style='margin: 0; color: #991B1B;'><strong>ATENCIÓN: Se ha reportado una incidencia de prioridad CRÍTICA que requiere atención inmediata.</strong></p>\r\n                </div>\r\n                \r\n                <div style='background: #FEF3C7; padding: 15px; border-left: 4px solid #F59E0B; margin: 20px 0;'>\r\n                    <p><strong>ID:</strong> #{\$data['id_incidencia']}</p>\r\n                    <p><strong>Título:</strong> {\$data['titulo']}</p>\r\n                    <p><strong>Descripción:</strong> {\$data['descripcion']}</p>\r\n                    <p><strong>Prioridad:</strong> <span style='color: #EF4444; font-weight: bold;'>CRÍTICA</span></p>\r\n                    <p><strong>Reportado por:</strong> {\$data['reportante']}</p>\r\n                </div>\r\n                \r\n                <p style='font-weight: bold; color: #991B1B;'>Esta incidencia requiere atención inmediata. Por favor, asigna un técnico lo antes posible.</p>\r\n                \r\n                <p style='margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px;'>\r\n                    Este es un mensaje automático del Sistema de Gestión de Incidencias - Clínica Carita Feliz\r\n                </p>\r\n            </div>\r\n        </body>\r\n        </html>\r\n        \";\r\n    }\r\n}\r\n?>";

$newContent = str_replace($search, $newMethods, $content);

if ($newContent !== $content) {
    file_put_contents($file, $newContent);
    echo "✅ Métodos agregados exitosamente a EmailNotifier.php\n";
    echo "Se agregaron:\n";
    echo "  - notificarNuevaIncidencia()\n";
    echo "  - notificarIncidenciaCritica()\n";
    echo "  - generarMensajeNuevaIncidencia()\n";
    echo "  - generarMensajeIncidenciaCritica()\n";
} else {
    echo "❌ No se pudo realizar el reemplazo\n";
    echo "Buscando patrón alternativo...\n";
}
?>
